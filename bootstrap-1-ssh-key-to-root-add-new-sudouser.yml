- name: bootstrap-1-ssh-key-to-root-add-new-sudouser
  hosts: bootstrap
  gather_facts: true
  remote_user: root
  become: false
  vars:
    ansible_user: root
    ansible_become: false
    bootstrap_root_ssh_private_key_file: "{{ lookup('env', 'HOME') + '/.ssh/operator_key' }}"
    ansible_ssh_private_key_file: "{{ bootstrap_root_ssh_private_key_file }}"
    ansible_ssh_common_args: "-o PreferredAuthentications=publickey -o PasswordAuthentication=no -o KbdInteractiveAuthentication=no -o IdentitiesOnly=yes"
    sshd_config_path: /etc/ssh/sshd_config

  tasks:
    - name: Ensure sudo is installed
      ansible.builtin.apt:
        name: sudo
        state: present
        update_cache: true

    - name: Create user
      ansible.builtin.user:
        name: "{{ new_user }}"
        shell: /bin/bash
        create_home: true
        groups: sudo
        append: true

    - name: Check account status (passwd -S)
      ansible.builtin.command: "passwd -S {{ new_user }}"
      register: passwd_status
      changed_when: false

    - name: Set random password hash to unlock account (SSH key only)
      ansible.builtin.shell: |
        usermod -p "$(openssl passwd -6 "$(openssl rand -base64 32)")" {{ new_user }}
      args:
        executable: /bin/bash
      changed_when: true
      when: new_user ~ ' L' in passwd_status.stdout

    - name: Allow passwordless sudo for the user
      ansible.builtin.copy:
        dest: "/etc/sudoers.d/{{ new_user }}"
        content: "{{ new_user }} ALL=(ALL) NOPASSWD:ALL\n"
        owner: root
        group: root
        mode: "0440"

    - name: Add public key for the user
      ansible.builtin.authorized_key:
        user: "{{ new_user }}"
        state: present
        key: "{{ new_user_pubkey }}"

    - name: Ensure user's authorized_keys exists and is not empty
      ansible.builtin.stat:
        path: "/home/{{ new_user }}/.ssh/authorized_keys"
      register: user_keys_file

    - name: Fail if user authorized_keys missing (safety check)
      ansible.builtin.fail:
        msg: "User SSH key file is missing; cannot proceed."
      when: (not user_keys_file.stat.exists) or (user_keys_file.stat.size | default(0) | int == 0)

    - name: Normalize shared Ansible remote_tmp permissions
      ansible.builtin.file:
        path: /var/tmp/ansible-tmp
        state: directory
        owner: root
        group: root
        mode: "1777"
    
    - name: Print manual next step
      ansible.builtin.debug:
        msg: "! ! ! CHECK SSH CONNECTION FOR '{{ new_user }}'"
