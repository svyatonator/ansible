#!/usr/bin/env bash
set -euo pipefail

ROOT="{{ openclaw_root }}"
BACKUP_DIR="{{ openclaw_backup }}"
ARCHIVE="${1:-}"

if [ -z "${ARCHIVE}" ]; then
  echo "Usage: restore-openclaw.sh /path/to/openclaw_YYYY-MM-DD_HH-MM-SS.tar.gz"
  exit 1
fi

if [ ! -f "${ARCHIVE}" ]; then
  echo "Archive not found: ${ARCHIVE}"
  exit 1
fi

STAMP="$(date +%F_%H-%M-%S)"
PRE_RESTORE="${BACKUP_DIR}/pre_restore_${STAMP}.tar.gz"

# Safety net: create a snapshot before restoring.
mkdir -p "${BACKUP_DIR}" "${ROOT}"

snapshot_items=(
  "{{ openclaw_home | basename }}"
  "{{ openclaw_skills | basename }}"
{% if openclaw_backup_include_workspace %}
  "{{ openclaw_workspace | basename }}"
{% endif %}
)

if [ -f "${ROOT}/docker-compose.yml" ]; then
  snapshot_items+=("docker-compose.yml")
fi

tar -czf "${PRE_RESTORE}" -C "${ROOT}" "${snapshot_items[@]}"

echo "Pre-restore backup created: ${PRE_RESTORE}"

if [ -f "${ROOT}/docker-compose.yml" ]; then
  cd "${ROOT}"
  docker compose down || true
fi

tar -xzf "${ARCHIVE}" -C "${ROOT}"

if [ ! -f "${ROOT}/docker-compose.yml" ]; then
  echo "docker-compose.yml not found after restore at ${ROOT}"
  exit 1
fi

cd "${ROOT}"
docker compose up -d

echo "Restore completed from: ${ARCHIVE}"
